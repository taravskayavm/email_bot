"""Helpers for classifying email domains by geography."""  # Описываем назначение модуля

from __future__ import annotations  # Включаем поддержку аннотаций будущего

from typing import Tuple  # Импортируем тип Tuple для явной типизации возвращаемых значений

from emailbot.settings import (  # Загружаем настройки с параметрами доменных зон
    LOCAL_TLDS,  # Множество доменных зон, которые считаем локальными
    LOCAL_DOMAINS_EXTRA,  # Дополнительные локальные домены, заданные явно
    FORCE_FOREIGN_DOMAINS,  # Домены, которые всегда относятся к иностранным
)


def split_domain(email: str) -> Tuple[str, str]:  # Определяем доменную часть адреса
    """Вернуть пару «локальная часть» и «домен» в нижнем регистре."""  # Поясняем, что делает функция

    cleaned = (email or "").strip()  # Нормализуем исходную строку: заменяем None, убираем пробелы
    if "@" not in cleaned:  # Проверяем, содержится ли разделитель email'а
        return cleaned, ""  # При отсутствии '@' возвращаем исходное значение и пустой домен
    local, domain = cleaned.rsplit("@", 1)  # Делим строку на локальную часть и домен по последнему '@'
    return local.lower(), domain.lower()  # Приводим обе части к нижнему регистру для унификации


def is_foreign_email(email: str) -> bool:  # Определяем, считается ли адрес иностранным
    """Проверить домен e-mail по правилам локальных и принудительно иностранных списков."""  # Объясняем алгоритм функции

    _, domain = split_domain(email)  # Извлекаем доменную часть адреса
    if not domain:  # Если домен не удалось выделить
        return False  # Считаем адрес локальным, чтобы не отбрасывать сомнительные данные
    if domain in FORCE_FOREIGN_DOMAINS:  # Проверяем домен в принудительном иностранном списке
        return True  # Немедленно считаем адрес иностранным
    if domain in LOCAL_DOMAINS_EXTRA:  # Сравниваем домен с дополнительными локальными значениями
        return False  # Для разрешённых доменов возвращаем False
    tld = ("." + domain.rsplit(".", 1)[-1]) if "." in domain else ""  # Вычисляем TLD с точкой, если возможно
    return tld not in LOCAL_TLDS  # Возвращаем True, если TLD не входит в список локальных зон
